on:
  workflow_call:
name: SAST com Trivy
runs: 
  using: 'composite'
  steps:
    - name: Find Credentials
      shell: bash
      run: |
 
          # Execute o Trivy e obtenha o resumo dos resultados em formato Text/Plain. Tentei Json mas não consegui
          # Observação: este comando pressupõe que Trivy já está instalado e configurado na máquina local
          trivy image rodrigomotadevops/${{ env.environment }}-${{ github.event.repository.name }}:latest > trivy_results.json
          
          # Use o jq para contar as entradas CVEs no JSON
          # Instale o jq caso ainda não esteja instalado na sua máquina
          content=$(cat trivy_results.json)
          
          # Use o comando sed para extrair os valores e atribuí-los às variáveis
          UNKNOWN=$(echo $content | sed -n 's/.*UNKNOWN: \([0-9]*\).*/\1/p')
          LOW=$(echo $content | sed -n 's/.*LOW: \([0-9]*\).*/\1/p')
          MEDIUM=$(echo $content | sed -n 's/.*MEDIUM: \([0-9]*\).*/\1/p')
          HIGH=$(echo $content | sed -n 's/.*HIGH: \([0-9]*\).*/\1/p')
          CRITICAL=$(echo $content | sed -n 's/.*CRITICAL: \([0-9]*\).*/\1/p')
          
          # Echo the values to verify that they're correct
          echo "UNKNOWN: $UNKNOWN"
          echo "LOW: $LOW"
          echo "MEDIUM: $MEDIUM"
          echo "HIGH: $HIGH"
          echo "CRITICAL: $CRITICAL"
          TOTAL=$(($UNKNOWN + $LOW + $MEDIUM + $HIGH + $CRITICAL))
          # Exportação da contagem de CVEs para um arquivo
          echo "Quantidade de CVEs: $TOTAL" 
          
          curl -k -X 'PUT' \
            'https://192.168.0.93:32776/api/Analitics/0' \
            -H 'accept: text/plain' \
            -H 'Content-Type: application/json' \
            -d '{
            "id": 0,
            "nomeRepositorio": "'${{ github.event.repository.name }}'",
            "cve_low": "'$LOW'",
            "cve_medium": "'$MEDIUM'",
            "cve_high": "'$HIGH'",
            "cve_critical": "'$CRITICAL'"
          
          }'
          
          # Remova o arquivo JSON caso não queira mantê-lo
          rm trivy_results.json
          
              
